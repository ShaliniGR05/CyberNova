<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Packet Sniffer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¡ Network Packet Sniffer</h1>
            <p>Real-time network packet capture with security classification</p>
            
            <div class="controls">
                <button id="startBtn" class="btn btn-success">Start Monitoring</button>
                <button id="stopBtn" class="btn btn-danger" disabled>Stop Monitoring</button>
                <button id="clearBtn" class="btn btn-warning">Clear Events</button>
                <span class="status" id="status">Stopped</span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-label">Total Packets</div>
            </div>
            <div class="stat-item success">
                <div class="stat-value" id="secureCount">0</div>
                <div class="stat-label">Secure Protocols</div>
            </div>
            <div class="stat-item danger">
                <div class="stat-value" id="insecureCount">0</div>
                <div class="stat-label">Insecure Protocols</div>
            </div>
            <div class="stat-item info">
                <div class="stat-value" id="tcpCount">0</div>
                <div class="stat-label">TCP Packets</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-value" id="udpCount">0</div>
                <div class="stat-label">UDP Packets</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="eventsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Source IP</th>
                        <th>Destination IP</th>
                        <th>Source Port</th>
                        <th>Dest Port</th>
                        <th>Transport</th>
                        <th>Application</th>
                        <th>Packet Size</th>
                        <th>TCP Flags</th>
                        <th>Security</th>
                    </tr>
                </thead>
                <tbody id="eventsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let eventCounts = {total: 0, secure: 0, insecure: 0, tcp: 0, udp: 0};
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const eventsBody = document.getElementById('eventsBody');
        
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        clearBtn.addEventListener('click', clearEvents);
        
        async function startMonitoring() {
            try {
                const response = await fetch('/api/start');
                const data = await response.json();
                
                if (data.status === 'started' || data.status === 'already running') {
                    isMonitoring = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusEl.textContent = 'Monitoring';
                    statusEl.className = 'status status-active';
                    
                    pollEvents();
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
            }
        }
        
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop');
                const data = await response.json();
                
                isMonitoring = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusEl.textContent = 'Stopped';
                statusEl.className = 'status';
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        }
        
        async function clearEvents() {
            try {
                await fetch('/api/clear');
                eventsBody.innerHTML = '';
                eventCounts = {total: 0, secure: 0, insecure: 0, tcp: 0, udp: 0};
                updateStats();
            } catch (error) {
                console.error('Error clearing events:', error);
            }
        }
        
        async function pollEvents() {
            while (isMonitoring) {
                try {
                    const response = await fetch('/api/events');
                    const events = await response.json();
                    
                    displayEvents(events);
                    updateStats();
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error('Error polling events:', error);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }
        
        function displayEvents(events) {
            eventsBody.innerHTML = '';
            eventCounts = {total: 0, secure: 0, insecure: 0, tcp: 0, udp: 0};
            
            // Limit display to last 500 events for performance
            const displayEvents = events.slice(-500);
            
            displayEvents.forEach(event => {
                if (event.error) {
                    const row = document.createElement('tr');
                    row.className = 'row-error';
                    row.innerHTML = `
                        <td colspan="10" class="error-cell">Error: ${event.error}</td>
                    `;
                    eventsBody.appendChild(row);
                    return;
                }
                
                eventCounts.total++;
                
                // Count by security
                if (event.secure === 'Secure') {
                    eventCounts.secure++;
                } else if (event.secure === 'Insecure') {
                    eventCounts.insecure++;
                }
                
                // Count by transport
                if (event.transport === 'TCP') {
                    eventCounts.tcp++;
                } else if (event.transport === 'UDP') {
                    eventCounts.udp++;
                }
                
                const row = document.createElement('tr');
                
                // Set row class based on security
                if (event.secure === 'Secure') {
                    row.className = 'row-success';
                } else if (event.secure === 'Insecure') {
                    row.className = 'row-danger';
                } else {
                    row.className = 'row-info';
                }
                
                row.innerHTML = `
                    <td>${new Date(event.timestamp).toLocaleTimeString()}</td>
                    <td>${event.src_ip || '-'}</td>
                    <td>${event.dst_ip || '-'}</td>
                    <td>${event.src_port || '-'}</td>
                    <td>${event.dst_port || '-'}</td>
                    <td><span class="transport-badge ${event.transport.toLowerCase()}">${event.transport}</span></td>
                    <td>${event.app_protocol || 'Unknown'}</td>
                    <td>${formatBytes(event.packet_len)}</td>
                    <td class="flags-cell">${event.tcp_flags || '-'}</td>
                    <td><span class="security-badge ${event.secure.toLowerCase()}">${event.secure}</span></td>
                `;
                
                eventsBody.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('eventCount').textContent = eventCounts.total;
            document.getElementById('secureCount').textContent = eventCounts.secure;
            document.getElementById('insecureCount').textContent = eventCounts.insecure;
            document.getElementById('tcpCount').textContent = eventCounts.tcp;
            document.getElementById('udpCount').textContent = eventCounts.udp;
        }
        
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>

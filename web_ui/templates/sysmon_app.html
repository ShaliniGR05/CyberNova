<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sysmon application Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚙️ Sysmon application Scanner</h1>
            <p>Real-time monitoring of Sysmon events with application filtering</p>
            
            <div class="controls">
                <label for="appSelect" style="margin-right:8px;">Application:</label>
                <select id="appSelect" style="min-width:260px; max-width:420px;"></select>
                <button id="applyAppBtn" class="btn">Apply</button>
                <button id="clearAppBtn" class="btn">Clear</button>
                <span id="selectedAppLabel" style="margin-left:10px; font-style:italic;"></span>
                <br/>
                <button id="startBtn" class="btn btn-success">Start Monitoring</button>
                <button id="stopBtn" class="btn btn-danger" disabled>Stop Monitoring</button>
                <button id="clearBtn" class="btn btn-warning">Clear Events</button>
                <span class="status" id="status">Stopped</span>
                <span id="errorLabel" style="margin-left:10px;color:#b00020;"></span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="processEvents">0</div>
                <div class="stat-label">Process Events</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="networkEvents">0</div>
                <div class="stat-label">Network Events</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="fileEvents">0</div>
                <div class="stat-label">File Events</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="eventsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Event ID</th>
                        <th>Provider</th>
                        <th>Computer</th>
                        <th>Record ID</th>
                        <th>Process Image</th>
                        <th>Command Line</th>
                        <th>Network Info</th>
                        <th>File Path</th>
                    </tr>
                </thead>
                <tbody id="eventsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let eventCounts = {total: 0, process: 0, network: 0, file: 0};
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const eventsBody = document.getElementById('eventsBody');
    const appSelect = document.getElementById('appSelect');
    const applyAppBtn = document.getElementById('applyAppBtn');
    const clearAppBtn = document.getElementById('clearAppBtn');
    const selectedAppLabel = document.getElementById('selectedAppLabel');
    const errorLabel = document.getElementById('errorLabel');
        
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        clearBtn.addEventListener('click', clearEvents);
    applyAppBtn.addEventListener('click', applyAppFilter);
    clearAppBtn.addEventListener('click', clearAppFilter);

    // Load apps at startup
    loadApps();
        
        async function startMonitoring() {
            try {
                const response = await fetch('/api/start');
                const data = await response.json();
                
                if (data.status === 'started' || data.status === 'already running') {
                    isMonitoring = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusEl.textContent = 'Monitoring';
                    statusEl.className = 'status status-active';
                    
                    // Start polling for events
                    pollEvents();
                    refreshStatus();
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
            }
        }
        
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop');
                const data = await response.json();
                
                isMonitoring = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusEl.textContent = 'Stopped';
                statusEl.className = 'status';
                refreshStatus();
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        }
        
        async function clearEvents() {
            try {
                await fetch('/api/clear');
                eventsBody.innerHTML = '';
                eventCounts = {total: 0, process: 0, network: 0, file: 0};
                updateStats();
            } catch (error) {
                console.error('Error clearing events:', error);
            }
        }
        
        async function pollEvents() {
            while (isMonitoring) {
                try {
                    const response = await fetch('/api/events');
                    const events = await response.json();
                    
                    displayEvents(events);
                    updateStats();
                    if (Math.random() < 0.25) { // occasionally refresh status
                        refreshStatus();
                    }
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    console.error('Error polling events:', error);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }

        async function loadApps() {
            appSelect.innerHTML = '';
            const optAll = document.createElement('option');
            optAll.value = '';
            optAll.textContent = 'All applications';
            appSelect.appendChild(optAll);
            try {
                const res = await fetch('/api/apps');
                const apps = await res.json();
                apps.forEach(a => {
                    if (!a.name) return;
                    const opt = document.createElement('option');
                    opt.value = a.name;
                    opt.textContent = a.name;
                    appSelect.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load apps', e);
            }
        }

        async function applyAppFilter() {
            const name = appSelect.value || '';
            try {
                const res = await fetch('/api/select_app', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }),
                });
                const data = await res.json();
                selectedAppLabel.textContent = data.selected_app ? `Filtering: ${data.selected_app}` : 'Filtering: All applications';
                await clearEvents();
                await refreshStatus();
            } catch (e) {
                console.error('Failed to apply app filter', e);
            }
        }

        async function clearAppFilter() {
            appSelect.value = '';
            await applyAppFilter();
        }

        async function refreshStatus() {
            try {
                const res = await fetch('/api/status');
                const s = await res.json();
                if (typeof s.monitoring === 'boolean') {
                    isMonitoring = s.monitoring;
                    startBtn.disabled = isMonitoring;
                    stopBtn.disabled = !isMonitoring;
                    statusEl.textContent = isMonitoring ? 'Monitoring' : 'Stopped';
                    statusEl.className = isMonitoring ? 'status status-active' : 'status';
                }
                selectedAppLabel.textContent = s.selected_app ? `Filtering: ${s.selected_app}` : 'Filtering: All applications';
                errorLabel.textContent = s.last_error ? `Error: ${s.last_error}` : '';
            } catch (e) {
                console.error('Failed to refresh status', e);
            }
        }
        
        function displayEvents(events) {
            eventsBody.innerHTML = '';
            eventCounts = {total: 0, process: 0, network: 0, file: 0};
            
            events.forEach(event => {
                eventCounts.total++;
                
                // Categorize events
                if (event.EventID === 1) eventCounts.process++;
                else if (event.EventID === 3) eventCounts.network++;
                else if ([11, 23, 26].includes(event.EventID)) eventCounts.file++;
                
                const row = document.createElement('tr');
                
                // Get event data
                const eventData = event.EventData || {};
                const processImage = eventData.Image || eventData.SourceImage || '-';
                const commandLine = eventData.CommandLine || '-';
                const networkInfo = event.EventID === 3 ? 
                    `${eventData.SourceIp || ''}:${eventData.SourcePort || ''} → ${eventData.DestinationIp || ''}:${eventData.DestinationPort || ''}` : '-';
                const filePath = eventData.TargetFilename || eventData.ImageLoaded || '-';
                
                row.innerHTML = `
                    <td>${new Date(event.TimeCreated).toLocaleString()}</td>
                    <td><span class="event-id event-id-${event.EventID}">${event.EventID}</span></td>
                    <td>${event.Provider}</td>
                    <td>${event.Computer}</td>
                    <td>${event.RecordID}</td>
                    <td class="path-cell" title="${processImage}">${processImage}</td>
                    <td class="command-cell" title="${commandLine}">${commandLine}</td>
                    <td>${networkInfo}</td>
                    <td class="path-cell" title="${filePath}">${filePath}</td>
                `;
                
                eventsBody.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('eventCount').textContent = eventCounts.total;
            document.getElementById('processEvents').textContent = eventCounts.process;
            document.getElementById('networkEvents').textContent = eventCounts.network;
            document.getElementById('fileEvents').textContent = eventCounts.file;
        }
        
        function truncateText(text, maxLength) {
            if (!text || text === '-') return text;
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
    </script>
</body>
</html>

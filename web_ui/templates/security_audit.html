<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Audit Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Security Audit Monitor</h1>
            <p>Real-time monitoring of Windows Security authentication events</p>
            
            <div class="controls">
                <button id="startBtn" class="btn btn-success">Start Monitoring</button>
                <button id="stopBtn" class="btn btn-danger" disabled>Stop Monitoring</button>
                <button id="clearBtn" class="btn btn-warning">Clear Events</button>
                <span class="status" id="status">Stopped</span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-item success">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">Successful Logons</div>
            </div>
            <div class="stat-item danger">
                <div class="stat-value" id="failureCount">0</div>
                <div class="stat-label">Failed Logons</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uniqueUsers">0</div>
                <div class="stat-label">Unique Users</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="eventsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Event Type</th>
                        <th>Event ID</th>
                        <th>User Name</th>
                        <th>Domain</th>
                        <th>Logon Type</th>
                        <th>Source IP</th>
                        <th>Computer</th>
                        <th>Record Number</th>
                    </tr>
                </thead>
                <tbody id="eventsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let eventCounts = {total: 0, success: 0, failure: 0};
        let uniqueUsers = new Set();
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const eventsBody = document.getElementById('eventsBody');
        
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        clearBtn.addEventListener('click', clearEvents);
        
        async function startMonitoring() {
            try {
                const response = await fetch('/api/start');
                const data = await response.json();
                
                if (data.status === 'started' || data.status === 'already running') {
                    isMonitoring = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusEl.textContent = 'Monitoring';
                    statusEl.className = 'status status-active';
                    
                    pollEvents();
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
            }
        }
        
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop');
                const data = await response.json();
                
                isMonitoring = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusEl.textContent = 'Stopped';
                statusEl.className = 'status';
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        }
        
        async function clearEvents() {
            try {
                await fetch('/api/clear');
                eventsBody.innerHTML = '';
                eventCounts = {total: 0, success: 0, failure: 0};
                uniqueUsers.clear();
                updateStats();
            } catch (error) {
                console.error('Error clearing events:', error);
            }
        }
        
        async function pollEvents() {
            while (isMonitoring) {
                try {
                    const response = await fetch('/api/events');
                    const events = await response.json();
                    
                    displayEvents(events);
                    updateStats();
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    console.error('Error polling events:', error);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }
        
        function displayEvents(events) {
            eventsBody.innerHTML = '';
            eventCounts = {total: 0, success: 0, failure: 0};
            uniqueUsers.clear();
            
            events.forEach(event => {
                eventCounts.total++;
                
                if (event.EventID === 4624) {
                    eventCounts.success++;
                } else if (event.EventID === 4625) {
                    eventCounts.failure++;
                }
                
                if (event.UserName && event.UserName !== 'Unknown') {
                    uniqueUsers.add(event.UserName.toLowerCase());
                }
                
                const row = document.createElement('tr');
                row.className = event.EventID === 4625 ? 'row-danger' : 'row-success';
                
                const ts = event.TimeGeneratedISO || event.TimeGenerated || event.timestamp;
                const safe = (v, d='') => (v === null || v === undefined ? d : v);
                row.innerHTML = `
                    <td>${ts ? new Date(ts).toLocaleString() : ''}</td>
                    <td><span class="event-type ${event.EventID === 4625 ? 'failure' : 'success'}">${safe(event.EventType, '')}</span></td>
                    <td>${safe(event.EventID, '')}</td>
                    <td>${safe(event.UserName, 'Unknown')}</td>
                    <td>${safe(event.Domain, 'Unknown')}</td>
                    <td>${safe(event.LogonType, 'Unknown')}</td>
                    <td>${safe(event.SourceIP, 'Local')}</td>
                    <td>${safe(event.ComputerName, '')}</td>
                    <td>${safe(event.RecordNumber, '')}</td>
                `;
                
                eventsBody.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('eventCount').textContent = eventCounts.total;
            document.getElementById('successCount').textContent = eventCounts.success;
            document.getElementById('failureCount').textContent = eventCounts.failure;
            document.getElementById('uniqueUsers').textContent = uniqueUsers.size;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File System Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÅ File System Monitor</h1>
            <p>Real-time monitoring of file system changes with ransomware detection</p>
            
            <div class="controls">
                <button id="startBtn" class="btn btn-success">Start Monitoring</button>
                <button id="stopBtn" class="btn btn-danger" disabled>Stop Monitoring</button>
                <button id="clearBtn" class="btn btn-warning">Clear Events</button>
                <span class="status" id="status">Stopped</span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-item info">
                <div class="stat-value" id="createdCount">0</div>
                <div class="stat-label">Files Created</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-value" id="modifiedCount">0</div>
                <div class="stat-label">Files Modified</div>
            </div>
            <div class="stat-item danger">
                <div class="stat-value" id="deletedCount">0</div>
                <div class="stat-label">Files Deleted</div>
            </div>
            <div class="stat-item alert">
                <div class="stat-value" id="alertCount">0</div>
                <div class="stat-label">Security Alerts</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="eventsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>File Name</th>
                        <th>File Path</th>
                        <th>Extension</th>
                        <th>Size (bytes)</th>
                        <th>Permissions</th>
                        <th>MD5 Hash</th>
                        <th>User</th>
                        <th>Alert</th>
                    </tr>
                </thead>
                <tbody id="eventsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let eventCounts = {total: 0, created: 0, modified: 0, deleted: 0, alerts: 0};
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const eventsBody = document.getElementById('eventsBody');
        
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        clearBtn.addEventListener('click', clearEvents);
        
        async function startMonitoring() {
            try {
                const response = await fetch('/api/start');
                const data = await response.json();
                
                if (data.status === 'started' || data.status === 'already running') {
                    isMonitoring = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusEl.textContent = 'Monitoring';
                    statusEl.className = 'status status-active';
                    
                    pollEvents();
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
            }
        }
        
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop');
                const data = await response.json();
                
                isMonitoring = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusEl.textContent = 'Stopped';
                statusEl.className = 'status';
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        }
        
        async function clearEvents() {
            try {
                await fetch('/api/clear');
                eventsBody.innerHTML = '';
                eventCounts = {total: 0, created: 0, modified: 0, deleted: 0, alerts: 0};
                updateStats();
            } catch (error) {
                console.error('Error clearing events:', error);
            }
        }
        
        async function pollEvents() {
            while (isMonitoring) {
                try {
                    const response = await fetch('/api/events');
                    const events = await response.json();
                    
                    displayEvents(events);
                    updateStats();
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    console.error('Error polling events:', error);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }
        
        function displayEvents(events) {
            eventsBody.innerHTML = '';
            eventCounts = {total: 0, created: 0, modified: 0, deleted: 0, alerts: 0};
            
            events.forEach(event => {
                if (event.error) {
                    const row = document.createElement('tr');
                    row.className = 'row-error';
                    row.innerHTML = `
                        <td colspan="10" class="error-cell">Error: ${event.error}</td>
                    `;
                    eventsBody.appendChild(row);
                    return;
                }
                
                eventCounts.total++;
                
                // Count by action
                if (event.action && event.action.includes('created')) {
                    eventCounts.created++;
                } else if (event.action && event.action.includes('modified')) {
                    eventCounts.modified++;
                } else if (event.action && event.action.includes('deleted')) {
                    eventCounts.deleted++;
                }
                
                if (event.alert) {
                    eventCounts.alerts++;
                }
                
                const row = document.createElement('tr');
                
                // Set row class based on action and alert
                if (event.alert) {
                    row.className = 'row-alert';
                } else if (event.action && event.action.includes('deleted')) {
                    row.className = 'row-danger';
                } else if (event.action && event.action.includes('modified')) {
                    row.className = 'row-warning';
                } else if (event.action && event.action.includes('created')) {
                    row.className = 'row-info';
                }
                
                const userName = event.user_info ? event.user_info.name : 'Unknown';
                const alertInfo = event.alert ? 
                    `‚ö†Ô∏è ${event.alert_message || 'Alert'}` : '';
                
                row.innerHTML = `
                    <td>${new Date(event.timestamp).toLocaleString()}</td>
                    <td><span class="action-badge ${event.action || 'unknown'}">${event.action || 'Unknown'}</span></td>
                    <td class="filename-cell" title="${event.file_name}">${truncateText(event.file_name, 20)}</td>
                    <td class="path-cell" title="${event.file_path}">${truncateText(event.file_path, 30)}</td>
                    <td>${event.extension || '-'}</td>
                    <td>${formatBytes(event.size_bytes)}</td>
                    <td>${event.permissions || '-'}</td>
                    <td class="hash-cell" title="${event.md5_hash}">${truncateText(event.md5_hash, 12)}</td>
                    <td>${userName}</td>
                    <td class="alert-cell">${alertInfo}</td>
                `;
                
                eventsBody.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('eventCount').textContent = eventCounts.total;
            document.getElementById('createdCount').textContent = eventCounts.created;
            document.getElementById('modifiedCount').textContent = eventCounts.modified;
            document.getElementById('deletedCount').textContent = eventCounts.deleted;
            document.getElementById('alertCount').textContent = eventCounts.alerts;
        }
        
        function truncateText(text, maxLength) {
            if (!text || text === '-') return text;
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
